name: Build AIO Docker

on:
  push:
    branches:
      - master
      - v[0-9]+.[0-9]+.x-staging
      - v[0-9]+.[0-9]+.x
    paths-ignore:
      - README.md
      - .github/**
      - '!.github/workflows/build-aio-docker.yml'
  pull_request:
    branches:
      - master
      - v[0-9]+.[0-9]+.x-staging
      - v[0-9]+.[0-9]+.x
    paths-ignore:
      - README.md
      - .github/**
      - '!.github/workflows/build.yml'

env:
  REGISTRY: ghcr.io
  NAMESPACE: toeverything
  CLOUD_IMAGE_NAME: affine-aio-self-hosted
  IMAGE_TAG: canary-${{ github.sha }}

jobs:
  build:
    name: Build @affine/web
    runs-on: ubuntu-latest
    environment: development

    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: ./.github/actions/setup-node
      - name: Cache Next.js
        uses: actions/cache@v3
        with:
          path: |
            ${{ github.workspace }}/apps/web/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-
      - name: Build
        run: yarn build
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}
          API_SERVER_PROFILE: docker
          ENABLE_DEBUG_PAGE: true
          ENABLE_LEGACY_PROVIDER: true
          COVERAGE: true

      - name: Export static resources
        run: yarn export
        working-directory: apps/web

      - name: Upload static resources artifact
        uses: actions/upload-artifact@v3
        with:
          name: next-js-static
          path: ./apps/web/out
          if-no-files-found: error

      - name: Get current time
        id: time
        run: echo "::set-output name=time::$(date +'%Y%m%d-%H%M')"

      - name: Extract metadata (tags, labels) for Docker (aio)
        id: meta_aio_docker
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.CLOUD_IMAGE_NAME }}
          tags: ${{ env.IMAGE_TAG }}-${{ steps.time.outputs.time }}

      - name: Build and push Docker image (aio)
        uses: docker/build-push-action@v3
        with:
          context: .
          platforms: linux/amd64,linux/arm/v7,linux/arm64/v8
          file: ./.github/deployment/Dockerfile
          push: ${{ github.ref == 'refs/heads/master' && true || false }}
          tags: ${{ steps.meta_aio_docker.outputs.tags }}
          labels: ${{ steps.meta_aio_docker.outputs.labels }}
